<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="assets/js/jquery-2.1.4.min.js"></script>
    
    <title>Websocket test page</title>
</head>
<body>

<div>
    <div>Client</div>
    
    <form>
    <div>
        Game id: <input id="game_id" value="0">
        <input type="button" onclick="WebSocketTest()" value="Join">
    </div>
    
    <div id="player-info"></div>
    
    <div>
        Sender planet <input id="src">Dest planet <input id="dst"> num <input id="num">
        <input type="button" id="launch" value="Launch">
    </div>
    
    </form>
</div>

<div style="float: right">
    <div>Host</div>
    <div id="host-info"></div>
    <input id="create" type="button" value="Create game">
    <input id="run" type="button" value="Run game">
</div>

<div id="test-block" style="width: 1000px;"></div>

<script>
    var host_game_id;
    
    $("#create").click(function() {
        $.ajax("/api/create/token").done(function(data) {
            $("#host-info").html(data);
            var d = JSON.parse(data);
            host_game_id = d.game_id;
        });
    });

    $("#run").click(function() {
        $.ajax("/api/run/" + host_game_id + "/token").done(function(data) {
            $("#host-info").html($("#host-info").html() + "<br>" + data);
        });
    });

    function WebSocketTest() {
        
        var player_id;
        
        if ("WebSocket" in window) {
            var ws = new WebSocket("ws://localhost:1337/api/join/" + $("#game_id").val() + "/token");

            $("#launch").click(function() {
                ws.send(JSON.stringify({command: "SendShips", data : {sender_id: $("#src").val(), dest_id: $("#dst").val(), num: $("#num").val()}}));
            });
            
            ws.onmessage = function(evt) {
                var msg = JSON.parse(evt.data);
                if (typeof msg.player_id != 'undefined') {
                    player_id = msg.player_id;
                    $("#player-info").html("player_id: " + player_id);
                }
                    
                var d = $("#test-block");
                d.html(evt.data + "<br>" + d.html());
            };

            ws.onclose = function() {
                alert("WebSocket closed.");
            };
        } else {
            alert("This browser does not support WebSockets.");
        }
    }
</script>
</body>
</html>
